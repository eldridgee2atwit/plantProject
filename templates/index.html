<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Monitoring Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Plant Monitoring Dashboard</h1>
        </header>
        
        <div class="dashboard">
            <div class="card moisture-card">
                <h2>Soil Moisture</h2>
                <div class="value" id="moisture-value">Loading...</div>
                <div class="status" id="moisture-status"></div>
            </div>

            <div class="card light-card">
                <h2>Light Status</h2>
                <div class="value" id="light-value">Loading...</div>
                <div class="status" id="light-status"></div>
            </div>

            <div class="controls">
                <button id="water-btn" class="btn water-btn">
                    <span class="icon">ðŸ’§</span>
                    Water Plant
                </button>
                <button id="light-btn" class="btn light-btn">
                    <span class="icon">ðŸ’¡</span>
                    Toggle Lights
                </button>
            </div>
        </div>
    </div>

    <script>
        // Store last valid values
        let lastValidMoisture = null;
        let lastValidLight = null;

        // Function to update moisture status
        function updateMoisture() {
            fetch('/api/soil-moisture')
                .then(response => response.json())
                .then(data => {
                    const moistureValue = document.getElementById('moisture-value');
                    const moistureStatus = document.getElementById('moisture-status');
                    
                    // Check if the value is valid (between 0 and 100)
                    if (data.moisture >= 0 && data.moisture <= 100) {
                        lastValidMoisture = data.moisture;
                        moistureValue.textContent = `${data.moisture}%`;
                        moistureStatus.textContent = 'Good';
                        moistureStatus.className = 'status good';
                    } else if (lastValidMoisture !== null) {
                        // Use last valid value if current value is invalid
                        moistureValue.textContent = `${lastValidMoisture}%`;
                        moistureStatus.textContent = 'Good';
                        moistureStatus.className = 'status good';
                    } else {
                        moistureValue.textContent = '--';
                        moistureStatus.textContent = 'Error';
                        moistureStatus.className = 'status error';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (lastValidMoisture !== null) {
                        const moistureValue = document.getElementById('moisture-value');
                        const moistureStatus = document.getElementById('moisture-status');
                        moistureValue.textContent = `${lastValidMoisture}%`;
                        moistureStatus.textContent = 'Good';
                        moistureStatus.className = 'status good';
                    }
                });
        }

        // Function to update light status
        function updateLight() {
            fetch('/api/light-level')
                .then(response => response.json())
                .then(data => {
                    const lightValue = document.getElementById('light-value');
                    const lightStatus = document.getElementById('light-status');
                    
                    // Check if the value is valid (0 or 1)
                    if (data.light === 0 || data.light === 1) {
                        lastValidLight = data.light;
                        lightValue.textContent = data.light === 0 ? 'ON' : 'OFF';
                        lightStatus.textContent = data.light === 0 ? 'ON' : 'OFF';
                        lightStatus.className = `status ${data.light === 0 ? 'on' : 'off'}`;
                    } else if (lastValidLight !== null) {
                        // Use last valid value if current value is invalid
                        lightValue.textContent = lastValidLight === 0 ? 'ON' : 'OFF';
                        lightStatus.textContent = lastValidLight === 0 ? 'ON' : 'OFF';
                        lightStatus.className = `status ${lastValidLight === 0 ? 'on' : 'off'}`;
                    } else {
                        lightValue.textContent = '--';
                        lightStatus.textContent = 'Error';
                        lightStatus.className = 'status error';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (lastValidLight !== null) {
                        const lightValue = document.getElementById('light-value');
                        const lightStatus = document.getElementById('light-status');
                        lightValue.textContent = lastValidLight === 0 ? 'ON' : 'OFF';
                        lightStatus.textContent = lastValidLight === 0 ? 'ON' : 'OFF';
                        lightStatus.className = `status ${lastValidLight === 0 ? 'on' : 'off'}`;
                    }
                });
        }

        // Water plant function
        document.getElementById('water-btn').addEventListener('click', () => {
            fetch('/api/water-plant')
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                })
                .catch(error => console.error('Error:', error));
        });

        // Toggle lights function
        document.getElementById('light-btn').addEventListener('click', () => {
            fetch('/api/toggle-lights')
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                })
                .catch(error => console.error('Error:', error));
        });

        // Update status every 5 seconds
        setInterval(() => {
            updateMoisture();
            updateLight();
        }, 5000);

        // Initial update
        updateMoisture();
        updateLight();
    </script>
</body>
</html> 